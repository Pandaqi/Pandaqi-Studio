<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width,height=device-height" />
	<title>SINT Game</title>
	<style type="text/css">
	body {
		margin:0;
		padding:0;
		width:100%;
		height:100%;
		background-color:Purple;
		overflow:hidden;
		font-family:Cartwheel;
		color:#fff;
	}
	#headLines div {
		text-align:center;
		background-color:#576d82;
		border-radius:0 0 10px 10px;
		width:20%;
		margin:20px;
		margin-top:0px;
		padding:20px;
		font-size:3vw;
		transition:transform 0.5s;
		transform:translateY(0px);
	}

	#headLines div:hover {
		box-shadow:0 0 15px #eee;
		cursor:pointer;
		transform:translateY(20px);
	}
	.aSmallPiet:hover,.curTeamSelection {
		box-shadow:0 0 15px #eee;
		background-color:orange !important;
		cursor:pointer;
	}

	.curBigSelection {
		background-color:orange !important;
		transform:translateY(20px) !important;
		color:#851919;
	}

	#teamSetup {
		border-spacing:40px;
	}
	#teamSetup > div {
		display:table-row;
	}
	#teamSetup > div > div {
		display:table-cell;
		vertical-align:center;
	}
	#teamSetup > div > div > div {
		background-color:#576d82;
		border-radius:20px;
		padding:20px;
		text-align:center;
	    margin-bottom:30px;
	}
	#teamSetup > div > div > div:not(.curTeamSelection):hover {
	    box-sizing:border-box;
		background-color:rgb(127,149,180);
	    box-shadow:0px 12px 0 rgb(67,89,120);
	    border-bottom:5px solid rgb(97,119,150);
	    border-top:5px solid rgb(167,179,210);
	    cursor:pointer;
	    margin-top:-5px;
	    margin-bottom:0px;
	}
	.greenBuyBtn,.redBuyBtn {
	    margin:10px;
	    padding:20px;
	    text-align:center;
		font-size:4vw;
		border-radius:10px;
		box-sizing:border-box;
	}
	.redBuyBtn {
		color:#997171;
		background-color:#FFBDBD;
	}
	.greenBuyBtn {
		color:#6D886E;
		background-color:#BDFFBF;
	}
	.disabledBuy {
		background-color:#9ACC9C;
	}
	.greenBuyBtn:not(.disabledBuy):hover {
	    box-shadow:0px 12px 0 #9ACC9C;
	    border-bottom:5px solid #ACEEAE;
	    border-top:5px solid #DFFFDF;
	    cursor:pointer;
	    margin-bottom:0px;
	}
	.redBuyBtn:hover {
	    box-shadow:0px 12px 0 #CC7979;
	    border-bottom:5px solid #EE9B9B;
	    border-top:5px solid #FFDFDF;
	    cursor:pointer;
	}
	#popupBox {
		position:absolute;top:0;left:0;bottom:0;right:0;
		margin:5% 15%;
		border-radius:60px;
		padding:60px;
		border:10px solid rgb(97,119,150);
		background-color:rgb(127,149,180);
		display:none;
	}

	/*** EXPERIMENTAL POPUP BUTTON STYLES ***/
	/*div 	    background-color{
:rgb(127,149,180);
	    width:200px;
	    height:100px;
	    border-radius:20px;
	    box-sizing:border-box;
	    box-shadow:0px 12px 0 rgb(67,89,120);
	    border-bottom:5px solid rgb(97,119,150);
	    border-top:5px solid rgb(167,179,210);
	    text-align:center;
	}*/
	span {
	    letter-spacing:2px;
	    font-size:2.5vw;
	    font-weight:bold;
	    font-family:Cartwheel;
	}
	span.money {
		font-size:48px;
		color:yellow;
	}
	span.nomoney {
		font-size:48px;
		color:red;
	}
	p {
		font-family:"Calibri";
		font-size:1vw;
	}
	#popupDesc {
		font-family:"Calibri";
		font-size:2vw;
		float:left;
		box-sizing:border-box;
		padding-right:100px;
		width:70%;
	}
	#popupBuy {
		float:left;
		width:30%;
		text-align:center;
	}
	/*** END EXPERIMENTAL STYLES ***/
	#completeTeam div {
		max-width:70px;
		padding:15px;
		margin:15px;
		text-align:center;
		border-radius:10px;
		background-color:#576d82;
	}
	#completeTeam div span {
		font-size:18px;
	}
	.progressOuter {
	    height:20px;
	    width:80%;
	    display:inline-block;
	    border:8px solid #ddd;
	}
	.progressInner {
	    height:100%;
	    display:block;
	    background-color:#aaa;
	}
	#bigContainerThingy {
		display:none;
	}
	.generalLevelBtn {
		background-repeat:no-repeat;
		background-position:center top;
		vertical-align:center;
	}
	.generalLevelBtn table tr td {
		background-color:#354b60;
	}
	.generalLevelBtn table tr td:hover {
		background-color:orange;
		box-shadow:0 0 15px #eee;
		transform:scale(1.2);
		transition:transform 0.3s;
	}
	</style>
	<script src="phaser2.min.js"></script>
	<script src="jquery-2.1.4.min.js"></script>
	<script src="Boot.js"></script>
	<script src="Load.js"></script>
	<script src="MainMenu.js"></script>
	<script src="MainGame.js"></script>
	<script src="GameOver.js"></script>
</head>
<body>
<div id="bigContainerThingy" style="position:absolute;top:0;left:0;width:100%;height:100%;margin-left:5%;">
	<div id="headLines" style="display:flex;flex-direction:row;justify-content:space-between;width:90%;position:absolute;top:-20px;">
		<div class="bigBtn">LEVELS</div>
		<div class="bigBtn">TEAM</div>
		<div class="bigBtn">WINKEL</div>
	</div>
	<div id="completeTeam" style="display:flex;flex-direction:row;justify-content:left;width:90%;position:absolute;top:80px;">
	</div>
	<div id="teamSetup" style="display:table;width:90%;height:80%;position:absolute;bottom:-40px;">
		<div>
			<div></div>
			<div></div>
			<div></div>
			<div></div>
		</div>
		<div>
			<div></div>
			<div></div>
			<div></div>
			<div></div>
		</div>
	</div>
</div>
<div id="popupBox">
	<div id="popupDesc">DESCRIPTION</div>
	<div id="popupBuy"><span class="money" id="popupMoney">&pound; 1000</span><br/><div class="greenBuyBtn">BUY</div><br/><div class="redBuyBtn">NOPE</div></div>
</div>
<script type="text/javascript">
var game = null;

var winkelItems = [["Dropper","1000",1],["Super Dropper","2000",2],["Super Vanger","3000",4],["Bewaker","4000",5],["Bruggenbouwer","5000",6],["Ninja","6000",3],["Pepernoter","3500",7],["Nog iets","5500"]];
var descriptions = ["De simpelste piet die er is. Kan pakjes die vlak langs hem komen oppakken, en van bovenaf recht naar beneden in de schoorsteen gooien. Goedkoop, maar een beetje dom.","Een upgrade voor de dropper. Kan pakjes van verre afstanden in de schoorsteen gooien.","Kan pakjes van een afstand vangen, maar ze niet in de schoorsteen gooien - hij kan ze alleen overgooien naar een vrijstaande piet.","Zorgt er voor dat de Sint op het dak blijft. De Sint zal nooit langs deze piet lopen, tenzij hij op volle snelheid is!","Als deze in de buurt van een ravijn komt, verschijnt er automatisch een brug. Kan geen pakjes oppakken of gooien, maar kan wel op de grond gaan liggen om neerstortende pakjes tegen te houden.<br/><br/>LET OP: Hij kan pakjes duwen, maar pakjes kunnen ook hem van het dak duwen","Kan pakjes van dichtbij pakken, en ze met één druk op de knop overal bezorgen. Hoeft niet veel te lopen, maar kost even de tijd voordat ie weer terug is van zijn reis","Kan als enige pepernoten oppakken. Een groot aantal pepernoten zorgt voor een extra leven voor de Sint!"];
if(localStorage.getItem("SINTGameSavings") == null || localStorage.getItem("SINTGameSavings") == undefined) {
	var dummyData = {pieten:[],team:[],money:1000}
	localStorage.setItem("SINTGameSavings",JSON.stringify(dummyData));
}
var myData = JSON.parse(localStorage.getItem("SINTGameSavings"));

var currentItem = 0;
var prevSelection = null;
var curTeamSelection = null;
var curTeamNum = -1;
var curWorldSelection = null;
var levelSelected = -1;

var LEVELSETTINGS = [];
var FAILURE = false;

//First time login text
$("#teamSetup").html("<h1>Welkom!</h1><p>Dit is het menu. Bovenin zie je drie knopjes; de eerste brengt je naar alle levels, de tweede laat je team zien, en de derde opent de winkel. Daaronder zie je nu alleen nog maar je geld, 1000 euro, maar als je pieten hebt gekocht verschijnen ze allemaal daar links van.</p><p>Bij <b>LEVELS</b> kun je kiezen uit zes werelden, die allemaal 28 levels bevatten. Je mag een level spelen als je genoeg pieten in je team hebt. Klik er op om te beginnen - maar check wel eerst even hoe moeilijk het is!</p><p>Bij <b>WINKEL</b> kun je pieten kopen. Er zijn zeven pieten, elk met een andere functie en prijskaartje.</p><p>Bij <b>TEAM</b> kun je pieten die je hebt gekocht in je team zetten. Dit doe je door eerst op een lege plek in je team te klikken, en dan op de piet bovenin.</p><p>Als je een level succesvol afrondt, verdien je geld en verdienen je pieten ervaringspunten (<em>exp</em>). Daarmee kunnen ze naar hogere levels groeien, waardoor ze veel beter worden. Met het geld kun je weer nieuwe soorten pieten kopen.</p><p>De <b>BESTURING</b> is voor elke Piet hetzelfde: pijltjestoetsen links/rechts om te lopen, pijltjestoets omhoog om te springen, pijltjestoets omlaag om de speciale actie van de Piet uit te voeren. Je kunt een piet selecteren door op zijn nummer te drukken.</p>");

$(function() {
	buildTeamBar();

	$(".bigBtn").click(function() {
		var a = $(this).html();
		if(prevSelection != null) {
			prevSelection.removeClass("curBigSelection");
		}
		prevSelection = $(this);
		$(this).addClass("curBigSelection");
		if(a == 'WINKEL') {
			var build = '';
			for(var i=0;i<2;i++) {
				build += "<div>";
				for(var j=0;j<4;j++) {
					var dataNum = i*4+j;
					var hideIt = '';
					if(dataNum == 7) {
						hideIt = 'hidden';
					}
					build += "<div><div class='storeBtn' " + hideIt + " data-num='" + (winkelItems[dataNum][2]-1) + "'><span><img src='type" + winkelItems[dataNum][2] + ".png' /></span><br/><span>" + winkelItems[dataNum][0] + "</span><br/><span class='money'>&pound;" + winkelItems[dataNum][1] + "</span></div></div>";
				}
				build += "</div>";
			}
			$("#teamSetup").html(build);
		} else if(a == 'TEAM') {
			var build = '';
			for(var i=0;i<2;i++) {
				build += "<div>";
				for(var j=0;j<4;j++) {
					var dataNum = i*4+j;
					if(myData.team.length > dataNum) {
						var curP = myData.pieten[myData.team[dataNum]];
						var prog = calculateProgress(curP[2],curP[1]);
						build += "<div><div data-num='" + dataNum + "' class='teamBtn'><span><img src='type" + curP[0] + ".png' /></span><br/><br/><span>Lv. " + curP[1] + "</span><br/><br/><span class='progressOuter'><span class='progressInner' style='width:" + prog + "%;'></span></span></div></div>";
					} else {
						build += "<div><div data-num='" + dataNum + "' class='teamBtn'><hideTag style='visibility:hidden;'><span><img src='type1.png' /></span><br/><br/><span>Lv. 0</span><br/><br/><span class='progressOuter'><span class='progressInner'></span></span></hideTag></div></div>";
					}
				}
				build += "</div>";
			}
			$("#teamSetup").html(build);
		} else if(a == 'LEVELS') {
			var build = '';
			for(var i=0;i<2;i++) {
				build += "<div>";
				var whatWorld = ["Aardewereld","Kleurenwereld","Dakenwereld","Pepernotenwereld","Superwereld","Bijzonderwereld"];
				for(var j=0;j<3;j++) {
					var dataNum = i*3+j;
					var allLevels = '<table style="display:none;width:100%;margin-top:50px;">';
					for(var a=0;a<4;a++) {
						allLevels += '<tr>';
						for(var b=0;b<7;b++) {
							var levelNum = a*7+b+1 + '-' + i*3+j;
							allLevels += '<td class="specificLevelBtn" data-num="' + levelNum + '"><br/><br/>' + (a*7+b+1) + '<br/><br/></td>';							
						}
						allLevels += '</tr>';
					}
					allLevels += '</table>';
					build += "<div><div class='generalLevelBtn' data-num='" + dataNum + "'style='background-image:url(" + whatWorld[dataNum] + ".png);'><br/><span style='font-size:30px;'>" + whatWorld[dataNum] + "</span><br/>" + allLevels + "</div></div>";
				}
				build += "</div>";
			}
			$("#teamSetup").html(build);
		}
	});
	$("#teamSetup").on("click","div .storeBtn",function() {
		var a = parseInt($(this).attr('data-num'));
		currentItem = a;

		$("#popupBox").css('display','block');
		$("#teamSetup").css('opacity','0.3');
		var moneyDisplay = '&pound; ' + winkelItems[currentItem][1];
		if(winkelItems[currentItem][1] > myData.money) {
			$(".greenBuyBtn").addClass('disabledBuy');
			moneyDisplay += '<br/><span style="font-size:16px;color:#BDFDBD;">(not enough money!)</span>';
		} else {
			$(".greenBuyBtn").removeClass('disabledBuy');
		}
		$(".greenBuyBtn").html('BUY');
		$("#popupMoney").html(moneyDisplay);
		$("#popupDesc").html(descriptions[a]);
	});
	$("#teamSetup").on("click","div .teamBtn",function() {
		var a = parseInt($(this).attr('data-num'));
		if(a > myData.team.length) {
			return;
		}
		if(curTeamSelection != null) {
			curTeamSelection.removeClass("curTeamSelection");
		}
		if(curTeamNum == a) {
			curTeamSelection.removeClass("curTeamSelection");
			curTeamSelection = null;
			curTeamNum = -1;
		} else {
			$(this).addClass("curTeamSelection");
			curTeamSelection = $(this);
			curTeamNum = a;
		}
	});
	$("#teamSetup").on("click","div .generalLevelBtn",function() {
		var t = $(this).find('table');
		if(t.css('display') == 'none') {
			t.css('display','table');
			curWorldSelection = t;
		} else {
			t.css('display','none');
		}
		if(curWorldSelection != null && curWorldSelection != t) {
			curWorldSelection.css('display','none');			
		}
	});
	$("#teamSetup").on("click",".specificLevelBtn",function() {
		//Do not parseInt this one!
		var a = $(this).attr('data-num').split("-");
		a[0] = parseInt(a[0]);
		a[1] = parseInt(a[1]);
		var descWords = ["Pieten","Sint Level","Schoorstenen","Daken","Kleuren","Pepernoten Hoeveelheid","Daken Breedte","Gaten Breedte"];
		//Per setting, last number is total number of settings taken into account
		var maxAmounts = [1,1,1,1,1,1,1,1,4];
		switch(a[1]) {
			case 0:
				maxAmounts = [8,6,-5,0,0,0,6,0,4];
				break;
			case 1:
				maxAmounts = [8,6,2,4,3,0,0,0,5];
				break;
			case 2:
				maxAmounts = [8,6,0,6,0,0,-4,4,5];
				break;
			case 3:
				maxAmounts = [8,9,0,0,0,-10,0,0,3];
				break;
			case 4:
				maxAmounts = [8,6,-3,4,3,3,-2,2,8];
				break;
			case 5:
				break;
		}
		levelSelected = a;
		var theDescription = '<h1>Level ' + a[0] + '</h1>';
		var howMany = 1;
		var endNum = 0;
		for(var z=0;z<descWords.length;z++) {
			endNum = 0;
			if(maxAmounts[z] != 0) {
				var theTotalMax = maxAmounts[descWords.length];
				if(maxAmounts[z] < 0) {
					endNum = -1*maxAmounts[z] - Math.floor((a[0]-howMany)/theTotalMax);
				} else {
					endNum = Math.floor((a[0]-howMany)/theTotalMax)+1;					
				}
				//console.log(a[0] + '/' + howMany + '/' + theTotalMax)
				if(endNum > Math.abs(maxAmounts[z])) {
					endNum = Math.abs(maxAmounts[z]);
				}
				if(endNum < 1) {
					endNum = 1;
				}
				theDescription += endNum + ' ' + descWords[z] + '<br/>';
				howMany++;		
			}
			if(endNum == 0) {
				if(z != 5) {
					endNum = 1;
				}
			}
			LEVELSETTINGS[z] = endNum;
		}
		LEVELSETTINGS[descWords.length] = (30+a[0]*4);
		theDescription += '<br/>Tijdsduur: ' + (30+a[0]*4) + ' seconden';
		$("#popupBox").css('display','block');
		$("#teamSetup").css('opacity','0.3');
		$(".greenBuyBtn").html('PLAY');
		if(myData.team.length < LEVELSETTINGS[0]) {
			$(".greenBuyBtn").addClass('disabledBuy');
			var moneyDisplay = '<br/><span style="font-size:16px;color:#BDFDBD;">(not enough pieten!)</span>';
			$("#popupMoney").html(moneyDisplay);
		} else {
			$(".greenBuyBtn").removeClass('disabledBuy');
			$("#popupMoney").html('');			
		}
		$("#popupDesc").html(theDescription);
	});
	$("#completeTeam").on("click","div",function() {
		var a = parseInt($(this).attr('data-num'));
		if(curTeamNum != -1 && myData.team.indexOf(parseInt(a)) < 0) {
			//SWITCH
			var firstP = myData.pieten[myData.team[curTeamNum]];
			var secondP = myData.pieten[a];
			var prog = calculateProgress(secondP[2],secondP[1]);
			var buildHTML = "<span><img src='type" + secondP[0] + ".png' /></span><br/><br/><span>Lv. " + secondP[1] + "</span><br/><br/><span class='progressOuter'><span class='progressInner' style='width:" + prog + "%;'></span></span></div>";
			curTeamSelection.html(buildHTML);
			if(curTeamNum < myData.team.length) {
				var buildHTML = "<span><img src='type" + firstP[0] + ".png' style='max-width:60%;'/></span><br/><span>Lv. " + firstP[1] + "</span>";
				$(this).html(buildHTML);
				$(this).attr('data-num',(curTeamNum-1));
			}
			myData.team[curTeamNum] = a;
			curTeamSelection.removeClass("curTeamSelection");
			curTeamSelection = null;
			curTeamNum = -1;
			localStorage.setItem("SINTGameSavings",JSON.stringify(myData));
		}
	});
	$(".redBuyBtn").click(function() {
		$("#popupBox").css('display','none');
		$("#teamSetup").css('opacity','1');
		levelSelected = -1;
	});
	$(".greenBuyBtn").click(function() {
		if(!$(this).hasClass("disabledBuy")) {
			$("#popupBox").css('display','none');
			$("#teamSetup").css('opacity','1');
			if(levelSelected == -1) {
				myData.money -= winkelItems[currentItem][1];
				//Name/type, level, experience points
				myData.pieten.push([convertNameToNum(winkelItems[currentItem][0]),0,0]);
				localStorage.setItem("SINTGameSavings",JSON.stringify(myData));
				buildTeamBar();
			} else {
				loadLevel();
			}
		}
	});
});

window.onload = function() {
	game = new Phaser.Game('100%','100%',Phaser.AUTO,'O');
	game.state.add('Boot',Scene.Boot);
	game.state.add('Load', Scene.Load);
	game.state.add('MainMenu',Scene.MainMenu);
	game.state.add('Main', Scene.Main);
	game.state.add('GameOver', Scene.GameOver);
	game.state.start('Boot');
};

function loadLevel() {
	if(prevSelection != null) {
		prevSelection.removeClass("curBigSelection");
		prevSelection = null;
	}
	document.getElementById("bigContainerThingy").style.display = 'none';
	document.getElementById("teamSetup").innerHTML = '';
	game.paused = false;
	game.state.start('Main');	
}

function buildTeamBar() {
	var build = '';
	for(var i=0;i<myData.pieten.length;i++) {
		var a = myData.pieten[i][0];
		build += "<div class='aSmallPiet' data-num='" + i + "'><span><img src='type" + a + ".png' style='max-width:60%;'/></span><br/><span>Lv. " + myData.pieten[i][1] + "</span></div>";
	}
	if(myData.pieten.length > 0) {
		build += "<span style='position:absolute;right:200px;top:47px;color:#132940;'>&lt;= al jouw pieten</span>";		
	}
	build += "<span style='position:absolute;right:20px;top:25px;' class='money'>&pound;" + myData.money + "</span>";
	$("#completeTeam").html(build);
}

function convertNameToNum(a) {
	switch(a) {
		case 'Dropper':
			return 1;
		case 'Super Dropper':
			return 2;
		case 'Super Vanger':
			return 3;
		case 'Bewaker':
			return 4;
		case 'Bruggenbouwer':
			return 5;
		case 'Ninja':
			return 6;
		case 'Pepernoter':
			return 7;
			break;
	}
	return 1;
}
//a = experience, b = level
function calculateProgress(a,b) {
	var nextLevel = (b+1)*(b+1)*1000;
	var prevLevel = (b*b)*1000;
	return (a-prevLevel)/(nextLevel-prevLevel)*100;
}
</script>
</body>
</html>