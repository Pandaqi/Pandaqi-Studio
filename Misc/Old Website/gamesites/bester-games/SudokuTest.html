<head>
<title>Sudoku Test</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript">
	var cells = [];
	var numbers = [1,2,3,4,5,6,7,8,9];
	var showArray = [];
	var emptyCells = 0;

	function createSudoku() {
		//Populate array to make 2D array
		for(var i=0;i<9;i++) {
			cells[i] = [];
		}
		for(var i=0;i<9;i++) {
			var triedIt = 0;
			for(var j=0;j<9;j++) {
				var possNum = numbers.slice();
				//Remove if in same row
				for(var k=0;k<j;k++) {
					possNum.splice(possNum.indexOf(cells[i][k]),1);
				}
				//Remove if in same column
				for(var k=0;k<i;k++) {
					var index = possNum.indexOf(cells[k][j]);
					if(index > -1) {
						possNum.splice(possNum.indexOf(cells[k][j]),1);
					}
				}
				//Remove if in same box
				var whichRow = Math.floor(i/3);
				var whichColumn = Math.floor(j/3);
				for(var k=0;k<3;k++) {
					for(var l=0;l<3;l++) {
						var index = possNum.indexOf(cells[whichRow*3+k][whichColumn*3+l]);
						if(index > -1) {
							possNum.splice(index, 1);
						}
					}
				}

				if(possNum.length < 1) {
					//We've got no options left, return to previous state
					cells[i] = [];
					triedIt++;
					j = -1;
				} else {
					//Assign tha number!
					cells[i][j] = possNum[Math.round(Math.random()*(possNum.length-1))];	
				}
				if(triedIt > 100) {
					i=0;
					break;
				}
			}
		}
		mutilateSudoku();
	}

	function mutilateSudoku() {
		//Show array to show sudoku with empty cells
		for (var i=0;i<cells.length;i++) {
		    showArray[i] = cells[i].slice();
		}
		//Remove one random item from each 3x3 box
		for(var a=0;a<3;a++) {
			for(var b=0;b<3;b++) {
				showArray[a*3+Math.round(Math.random()*2)][b*3+Math.round(Math.random()*2)] = ' ';
				emptyCells++;
				//Remove one item if a row or column of the box is full
				var countRow = [0,0,0];
				for(var k=0;k<3;k++) {
					for(var l=0;l<3;l++) {
						if(showArray[a*3+k][b*3+l] != ' ') {
							countRow[k]++;
						}
					}
				}
				for(var z=0;z<3;z++) {
					if(countRow[z] > 2) {
						showArray[a*3+z][b*3+Math.round(Math.random()*2)] = ' ';
						emptyCells++;
					}
				}

				var countCol = [0,0,0];

				for(var k=0;k<3;k++) {
					for(var l=0;l<3;l++) {
						if(showArray[a*3+k][b*3+l] != ' ') {
							countCol[l]++;
						}
					}
				}
				for(var z=0;z<3;z++) {
					if(countCol[z] > 2) {
						showArray[a*3+Math.round(Math.random()*2)][b*3+z] = ' ';
						emptyCells++;
					}
				}
			}
		}
		//Remove one item of each number in ROWS if it has 3 (one in each row)
		for(var a=0;a<3;a++) {
			//Count occurences of number in set of 3 rows
			var occurences = [0,0,0,0,0,0,0,0,0];
			var occurencePlaces = [[],[],[],[],[],[],[],[],[]];
			for(var b=0;b<3;b++) {
				for(var k=0;k<9;k++) {
					if(showArray[a*3+b][k] != ' ') {
						occurences[showArray[a*3+b][k]-1]++;
						occurencePlaces[showArray[a*3+b][k]-1].push(a*3+b);
					}
				}
			}
			//Now remove based on the data!
			for(var z=0;z<9;z++) {
				if(occurences[z] > 1) {
					if(occurences[z] == 2 && Math.random() < 0.5) {
						continue;
					}
					var pickRow = occurencePlaces[z][Math.round(Math.random()*(occurencePlaces[z].length-1))];
					showArray[pickRow][showArray[pickRow].indexOf(z+1)] = ' '; 
					emptyCells++;
				}
			}
		}

		//Remove one item of each number in COLUMNS if it has 3 (one in each column)
		for(var a=0;a<3;a++) {
			//Count occurences of number in set of 3 rows
			var occurences = [0,0,0,0,0,0,0,0,0];
			var occurencePlaces = [[],[],[],[],[],[],[],[],[]];
			for(var b=0;b<3;b++) {
				for(var k=0;k<9;k++) {
					if(showArray[k][a*3+b] != ' ') {
						occurences[showArray[k][a*3+b]-1]++;
						occurencePlaces[showArray[k][a*3+b]-1].push(a*3+b);
					}
				}
			}
			//Now remove based on the data!
			for(var z=0;z<9;z++) {
				if(occurences[z] > 1) {
					if(occurences[z] == 2 && Math.random() < 0.5) {
						continue;
					}
					var pickCol = occurencePlaces[z][Math.round(Math.random()*(occurencePlaces[z].length-1))];
					var getIndex = -1;
					for(var y=0;y<9;y++) {
						if(showArray[y][pickCol] == (z+1)) {
							getIndex = y;
						}
					}
					showArray[getIndex][pickCol] = ' '; 
					emptyCells++;
				}
			}
		}

		updateDisplay();
	}

	function updateDisplay() {
		console.log(emptyCells + " of the " + 9*9);
		var theSud = "<table cellspacing='0' style='margin:auto;font-size:48px;color:#CC3300;font-family:Cartwheel'>";
		var counter = 0;
		for(var i=0;i<9;i++) {
			theSud += "<tr>";
			for(var j=0;j<9;j++) {
				var extraProps = '';
				if(i == 2 || i==5) {
					extraProps += 'border-bottom:2px solid gray;';
				}
				if(j == 2 || j == 5) {
					extraProps += 'border-right:2px solid gray;';
				}
				if(counter%2 == 0) {
					extraProps += 'background-color:#EEE;';
				}
				var toShow = showArray[i][j];
				if(toShow == ' ') {
					toShow = "<input type='text' onclick='this.placeholder=this.value;this.value=\"\";' class='inputThingy' id='" + i + "," + j + "' maxlength='1' style='text-align:center;background-color:transparent;width:48px;height:48px;font-size:48px;color:#0033CC;font-family:Cartwheel'/>";
				}
				theSud += "<td style='padding:20px;width:50px;height:50px;text-align:center;" + extraProps + "'>" + toShow + "</td>";
				counter++;
			}
			theSud += "</tr>";
		}
		theSud += "</table>";
		document.getElementById('return').innerHTML = theSud;
	}

	function checkSudoku() {
		var amountErrors = 0;
		$('.inputThingy').each(function(i, obj) {
		    var getID = obj.id;
		    var splitID = getID.split(',');
		    if(cells[splitID[0]][splitID[1]] != obj.value) {
		    	amountErrors++;
		    	if(obj.value.length==1) {
			    	obj.style.backgroundColor = 'rgba(255,127,80,0.2)';
		    	}
		    } else {
		    	obj.style.backgroundColor = 'rgba(0,255,0,0.2)';
		    }
		});
		if(amountErrors == 0) {
			alert("YOU DID IT! YOU ARE AMAZING!");
		} else {
			alert("You made: " + amountErrors + " errors. Loser.");
		}
	}

	function showSolution() {
		$('.inputThingy').each(function(i, obj) {
		    var getID = obj.id;
		    var splitID = getID.split(',');
		    obj.value = cells[splitID[0]][splitID[1]];
		});
	}
</script>
</head>

<body onLoad="createSudoku()">
<div id="return"></div><br/>
<div style="margin:auto;width:100%;text-align:center;">
<button style="font-size:32px;font-family:Cartwheel;background-color:transparent;padding:20px;" onClick="checkSudoku()">CHECK THIS SUDOKU!</button>
<button style="font-size:32px;font-family:Cartwheel;background-color:transparent;padding:20px;" onClick="showSolution()">SHOW THE SOLUTION!</button></div>
</body>