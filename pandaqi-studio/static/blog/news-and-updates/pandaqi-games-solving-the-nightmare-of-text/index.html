<!doctype html><html lang=en-US><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Pandaqi Games: Solving the Nightmare called Text | Pandaqi Blog</title>
<link rel=icon type=image/png href=https://pandaqi.com/blog//favicon.png><link rel=stylesheet type=text/css href=/blog/css/critical.min.css></head><body><header id=site-header><nav class=menu><ul><li><a href=https://pandaqi.com/blog/ class="masked-link big-mask mask-3" style=--rotation:2deg>Home</a></li><li><a href=/blog/boardgames/ class="masked-link big-mask mask-2" style=--rotation:-0.5deg>Boardgames</a></li><li><a href=/blog/news-and-updates/ class="masked-link big-mask mask-6" style=--rotation:0.5deg>News & Updates</a></li><li><a href=/blog/reviews-and-thoughts/ class="masked-link big-mask mask-5" style=--rotation:2deg>Reviews & Thoughts</a></li><li><a href=/blog/tutorials/ class="masked-link big-mask mask-3" style=--rotation:-1.5deg>Tutorials</a></li><li><a href=/blog/videogames/ class="masked-link big-mask mask-4" style=--rotation:1deg>Videogames</a></li></ul></nav></header><main class="padding center-block"><article class=single-article><h1>Pandaqi Games: Solving the Nightmare called Text</h1><aside class=metadata><nav class=breadcrumbs><span class=metadata-label><span class=emoji>ü•ê</span> Breadcrumbs ||</span>
<a href=https://pandaqi.com/blog/>Home</a>
/
<a href=/blog/>Blog</a>
/
<a href=/blog/news-and-updates/>News and updates</a>
/
<a href=/blog/news-and-updates/pandaqi-games-solving-the-nightmare-of-text/>Pandaqi games solving the nightmare of text</a></nav><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/pandaqi.com\/blog\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"\/blog\/","name":"blog"}},{"@type":"ListItem","position":4,"item":{"@id":"\/blog\/news-and-updates\/","name":"news-and-updates"}},{"@type":"ListItem","position":5,"item":{"@id":"\/blog\/news-and-updates\/pandaqi-games-solving-the-nightmare-of-text\/","name":"pandaqi-games-solving-the-nightmare-of-text"}}]}</script><div><span class=metadata-label><span class=emoji>&#8987;</span> Published ||</span>
<time datetime=2024-03-03T00:00:00>Sunday, Mar 3, 2024</time></div><div><span class=metadata-label><span class=emoji>üìñ</span> Table of Contents ||</span>
<a href=# id=toc-toggle>Show</a></div></aside><aside id=table-of-contents class=masked-link-block><header><h2>Table of Contents</h2></header><nav id=TableOfContents><ul><li><a href=#whats-the-problem>What&rsquo;s the problem?</a></li><li><a href=#the-first-approach>The first approach</a></li><li><a href=#how-to-wrap-text>How to wrap text?</a></li><li><a href=#how-to-find-text-dimensions>How to find text dimensions?</a></li><li><a href=#icons-and-styles-attempt-1>Icons and Styles: attempt 1</a></li><li><a href=#icons-and-styles-attempt-2>Icons and Styles: attempt 2</a><ul><li><a href=#whats-our-syntax>What&rsquo;s our syntax?</a></li><li><a href=#style-changes-through-state-management>Style changes through state management</a></li><li><a href=#how-to-do-images>How to do images?</a></li><li><a href=#doing-the-aligning-ourselves>Doing the aligning ourselves</a></li><li><a href=#other-minor-tweaks>Other minor tweaks</a></li></ul></li><li><a href=#where-are-we-now>Where are we now?</a></li></ul></nav></aside><div><p>My <a href=https://pandaqi.com>game studio website</a> has become so large and interactive these past few years that I basically have to do a big rewrite behind the scenes every few months now.</p><p>This article is about one of the biggest and most complex rewrites. The issue that plagued me for years until I finally took a break from my projects to add proper solutions.</p><p>It&rsquo;s called <strong>text</strong>. (More specifically, text blocks, text wrapping, and images inline with text.)</p><h2 id=whats-the-problem>What&rsquo;s the problem?</h2><p>On my website, for almost all board games, you can press a button and it <em>generates</em> the material on the spot.</p><p>It uses technologies that have been well-supported in all browsers for over a decade now, mainly <strong>Canvas</strong> and <strong>JavaScript</strong>.</p><p>The output is a high-resolution, professional PDF with the material (usually playing cards or tiles) you need for that game.</p><aside class="remark masked-link-block"><span class=label>Remark ||</span><p>My One Paper Games are similar, but they generate one <em>paper</em> or playing board for you, per game you want to play.</p></aside><p>Working with <em>images</em> is relatively easy.</p><ul><li>I create the correct image myself in drawing software.</li><li>Then simply use <code>drawImage</code> (on the canvas) to place the right frame of the image at the right location.</li></ul><p>Similarly, working with <em>shapes</em> is relatively easy.</p><ul><li>I create the correct points for the shape.</li><li>Then use the built in <code>path2D</code>, <code>stroke</code> and <code>fill</code> (of canvas) to create it.</li></ul><p>But text? Text is like an entirely different world. Every time I tried to tightly integrate it with the other code, I failed and had to compromise by making a separate class for drawing text.</p><p>Why?</p><ul><li>You have no clue about the dimensions beforehand. (Different cards will have different texts or powers, creating a text box of a different size. Even <em>single word</em> text boxes are obviously not consistent in width or height.)</li><li>In most cases, you want the text to <em>wrap</em>&mdash;to neatly stay inside its box instead of becoming one huge line.</li><li>Similarly, you often want different text styles <em>within</em> a text box, such as one word that is <strong>bold</strong>.</li><li>And as if that&rsquo;s not enough, any reasonably complex layout will also require <strong>images</strong> (mostly icons) inline with the text.</li></ul><p>When I just started making One Paper Games, I used the <em>Phaser</em> framework. Perhaps the biggest reason was that it supported a few nasty things, such as <em>text</em>, out of the box.</p><p>But despite being perhaps the biggest and most-used Canvas framework on the planet, it <em>does not support</em> changing styles or adding inline images.</p><p>If you want that, they advise you to just put an HTML container <em>on top of</em> your game, and use the built-in browser capabilities to render more complicated text.</p><p>This is a fine solution for interactive games, but simply doesn&rsquo;t apply to <em>generated images/PDFs</em>. When I generate a paper for your One Paper Game, I can&rsquo;t cheat my way through the text by placing some HTML elements <em>on top</em> of it. Because once you click the download/print button, those would be gone!</p><p>So I needed my own solution for displaying text, and that&rsquo;s how this journey started.</p><h2 id=the-first-approach>The first approach</h2><p>For my very first games, I took the approach of &ldquo;be smart with your layout, so you don&rsquo;t NEED that extra functionality&rdquo;.</p><p>In other words, I designed the cards in such a way that they needed no text, or only a <em>single</em> centered word.</p><p>This can be accomplished quite easily with</p><ul><li>Setting the <code>textAlign</code> property to <code>center</code></li><li>Then using the built-in <code>fillText</code> function to draw the text at some coordinates</li></ul><p>Each time I needed letters, I re-wrote the same 10 lines of code to put raw text onto the canvas.</p><p>This obviously stopped being fun after a few games&mdash;if it was ever fun&mdash;and stopped being useful once I really needed text that would wrap.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=kr>const</span> <span class=nx>canv</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;canvas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=kr>const</span> <span class=nx>ctx</span> <span class=o>=</span> <span class=nx>canv</span><span class=p>.</span><span class=nx>getContext</span><span class=p>(</span><span class=s2>&#34;2d&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nx>ctx</span><span class=p>.</span><span class=nx>textAlign</span> <span class=o>=</span> <span class=s2>&#34;center&#34;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=kr>const</span> <span class=nx>textToDisplay</span> <span class=o>=</span> <span class=s2>&#34;Play a card&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=kr>const</span> <span class=nx>position</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span> <span class=c1>// my custom class for 2d vector stuff
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=c1></span><span class=nx>ctx</span><span class=p>.</span><span class=nx>fillText</span><span class=p>(</span><span class=nx>textToDisplay</span><span class=p>,</span> <span class=nx>position</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>position</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span></span></span></code></pre></div><h2 id=how-to-wrap-text>How to wrap text?</h2><p>The Canvas has a useful function called <code>measureText</code>. It tests how much space a piece of text would take up&mdash;on the current canvas, with the current font settings&mdash;and returns that.</p><p>With that function in hand, the general algorithm is rather simple.</p><ul><li>Split the text into lines (by the <code>\n</code> symbol) and then words (by spaces).</li><li>Keep track of the current position (x and y)</li><li>Repeat the loop below until done.<ul><li>Measure the size of the next word.</li><li>If we&rsquo;ve exceeded the size of our text box, increase the Y-position and start on the next line</li><li>Otherwise, increase the X-position and keep going on this line</li></ul></li></ul><p>This places the text from top to bottom, left to right. How do we align it differently?</p><ul><li>Left? See above.</li><li>Center? Add <em>half</em> the size of the text box to the starting position, set <code>textAlign</code> to <code>center</code> when drawing.</li><li>Right? Add the <em>entire</em> size of the text box to the starting position, set <code>textAlign</code> to <code>right</code> when drawing.</li></ul><p>This is for the X-axis: the horizontal axis. The Y-axis is dynamic&mdash;it depends on the specific text and how it wraps&mdash;so we must calculate it differently.</p><ul><li>Top? See above.</li><li>Center? Calculate the empty space within the text box. (Total text box - height used by text) Add <em>half</em> that to the coordinates.</li><li>Right? Add the <em>entire</em> empty space to the coordinates.</li></ul><p>Below is some (incomplete, incorrect, but clear) pseudo-code for this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>inputText</span> <span class=o>=</span> <span class=s2>&#34;Play a card.\nImitate a crocodile.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kr>const</span> <span class=nx>lines</span> <span class=o>=</span> <span class=nx>inputText</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34;\n&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kd>let</span> <span class=nx>curLineWidth</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kd>let</span> <span class=nx>posY</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>for</span><span class=p>(</span><span class=kr>const</span> <span class=nx>line</span> <span class=k>of</span> <span class=nx>lines</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=kd>let</span> <span class=nx>lineTooLong</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=kd>let</span> <span class=nx>tempLine</span> <span class=o>=</span> <span class=nx>line</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=kd>let</span> <span class=nx>textLeftToProcess</span> <span class=o>=</span> <span class=nx>tempLine</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=k>while</span><span class=p>(</span><span class=nx>textLeftToProcess</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=nx>lineTooLong</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>      <span class=nx>removeLastWord</span><span class=p>();</span> <span class=c1>// tempLine = tempLine.slice(0, tempLine.lastIndexOf(&#34; &#34;));
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=c1></span>      <span class=nx>checkNewLength</span><span class=p>();</span> 
</span></span><span class=line><span class=ln>17</span><span class=cl>      <span class=c1>// newWidth = curLineWidth + ctx.measureText(tempLine).width;
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span>      <span class=c1>// lineTooLong = (newWidth &gt; textBoxWidth);
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=nx>drawLine</span><span class=p>();</span> <span class=c1>// use position = (0, posY);
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=c1></span>    <span class=nx>startNewLine</span><span class=p>();</span> <span class=c1>// curLineWidth = 0; posY += lineHeight;
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The remaining question is, of course, <em>how do we find the actual width/height used by the text?</em></p><h2 id=how-to-find-text-dimensions>How to find text dimensions?</h2><p>Here we see <em>another</em> nasty side of text.</p><p>Letters aren&rsquo;t uniform. Some letters have ascenders (such as <code>b</code>) or descenders (such as <code>p</code>) that stick out. Capital letters are obviously different from lowercase letters.</p><p>As such, the <code>measureText</code> actually returns several different metrics with subtle differences in how they&rsquo;re defined.</p><ul><li><code>actualBoundingBoxLeft</code>: left-most pixel</li><li><code>actualBoundingBoxRight</code>: right-most pixel</li><li><code>actualBoundingBoxAscent</code>: distance from center line to top-most pixel</li><li><code>actualBoundingBoxDescent</code>: distance from center line to bottom-most pixel</li></ul><p>In other words, to get the <em>true</em> (complete) height of a piece of text, we need to <em>add</em> the Ascent and Descent.</p><p>The distance between complete <em>lines</em> can be controlled by ourselves. In my code, there&rsquo;s a simple <code>lineHeight</code>: whenever it moves to a new line, that&rsquo;s the distance it adds to the coordinates.</p><p>When the text is <em>long</em> (many wrapped lines), you can simply multiply the number of lines by the lineHeight. It won&rsquo;t be exactly correct, but nobody will notice.</p><p>When the text is <em>short</em> however, I figured out I had to use the true size, otherwise the value could be <em>wildly inaccurate</em> and hence aligning looked inconsistent.</p><aside class="remark masked-link-block"><span class=label>Remark ||</span><p>For example, a card design might have certain powers that take 3 or 4 lines, but other powers that are so simple they only take 1 line. Using <em>line height</em> for height then would be completely wrong. Because there&rsquo;s only one line, and all you see is its specific height.</p></aside><p>Now that we know how to get the boundaries, we can get the exact, <em>actual</em> dimensions of the text by &mldr;</p><ul><li>Looping through all lines</li><li>Measuring them</li><li>And finding the <em>furthest</em> coordinates (minX, minY, maxX, maxY)</li></ul><p>I quickly learned that this distinction is important. Sometimes I want to center text based on the <em>text box</em> I supply, sometimes I want text centered based on the <em>actual</em> dimensions it happens to fill. As such, there&rsquo;s a toggle for this inside my system.</p><p>Again, below is hugely simplified pseudo-code for clarity.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>lines</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;Play a card&#34;</span><span class=p>,</span> <span class=s2>&#34;Help your neighbor&#34;</span><span class=p>];</span> <span class=c1>// an array of text chunks, one per line
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>minPos</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=kc>Infinity</span><span class=p>,</span> <span class=kc>Infinity</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kr>const</span> <span class=nx>maxPos</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=o>-</span><span class=kc>Infinity</span><span class=p>,</span> <span class=o>-</span><span class=kc>Infinity</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>for</span><span class=p>(</span><span class=kr>const</span> <span class=nx>line</span> <span class=k>of</span> <span class=nx>lines</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=kr>const</span> <span class=nx>metrics</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>measureText</span><span class=p>(</span><span class=nx>line</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=kr>const</span> <span class=nx>minPosLine</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>actualBoundingBoxLeft</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>actualBoundingBoxAscent</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=kr>const</span> <span class=nx>maxPosLine</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>actualBoundingBoxRight</span><span class=p>,</span> <span class=o>-</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>actualBoundingBoxDescent</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=nx>minPos</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>minPos</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>minPosLine</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=nx>minPos</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>minPos</span><span class=p>.</span><span class=nx>y</span><span class=p>,</span> <span class=nx>minPosLine</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=nx>maxPos</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nx>maxPos</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>maxPosLine</span><span class=p>.</span><span class=nx>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=nx>maxPos</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nx>maxPos</span><span class=p>.</span><span class=nx>y</span><span class=p>,</span> <span class=nx>maxPosLine</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=kr>const</span> <span class=nx>actualSize</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=nx>maxPos</span><span class=p>.</span><span class=nx>x</span> <span class=o>-</span> <span class=nx>minPos</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>maxPos</span><span class=p>.</span><span class=nx>y</span> <span class=o>-</span> <span class=nx>minPos</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1>// now use actualSize for positioning
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1>// for example, to align to BOTTOM (on Y-axis), we&#39;d start drawing the first line from this anchor position ...
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>anchorPos</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=nx>minPos</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=nx>maxPos</span><span class=p>.</span><span class=nx>y</span> <span class=o>-</span> <span class=nx>actualSize</span><span class=p>.</span><span class=nx>y</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>);</span></span></span></code></pre></div><h2 id=icons-and-styles-attempt-1>Icons and Styles: attempt 1</h2><p>This works fine. It&rsquo;s relatively fast and simple, yet will suit most games.</p><p>But certainly not all. I kept the system in this state for a while because it was daunting to move further, but I eventually created a game that simply <em>required</em> icons in line with the text.</p><p>Being a programmer, however, I first tried the lazy way out.</p><p>I wrote a simple script to turn any part of my layout into an HTML element. (In other words, each resource has a <code>toCanvas</code> function that puts it on the canvas, but also a <code>toHTML</code> that creates a <code>div</code> element and sets a few simple CSS properties to get the same look.)</p><p>Now I could use one of many &ldquo;html-to-canvas&rdquo; JavaScript libraries!</p><p>I could create my text as an HTML block, use CSS to modify styles, and then stamp that onto the canvas at the right location.</p><p>Below is some pseudo-code of the functions that would be on each &ldquo;Drawable&rdquo; object. (This is very inefficient and copies a lot of code. It&rsquo;s not how I actually do it, but it illustrates the concept.)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=nx>toCanvas</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=nx>ctx</span><span class=p>.</span><span class=nx>fillText</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>text</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=nx>toHTML</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;span&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=nx>span</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=nx>span</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>top</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>x</span> <span class=o>+</span> <span class=s2>&#34;px&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=nx>span</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>bottom</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>y</span> <span class=o>+</span> <span class=s2>&#34;px&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=nx>toCanvasUsingHTML</span><span class=p>()</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=kr>const</span> <span class=nx>node</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>toHTML</span><span class=p>();</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=kr>await</span> <span class=nx>htmlToCanvas</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span> <span class=c1>// this uses that external library
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>This works. After a few hours of fiddling and realizing a few stupid mistakes, it worked flawlessly and allowed me to make that game the next day.</p><p>But you probably feel the same way as I did. <em>Two</em> separate systems? A messy codebase that needs to connect different APIs and hope no update ever breaks it? When I was so close to doing it all with one unified system?</p><p>Furthermore, the effort it takes to <em>convert</em> pieces of the layout to HTML (so I can run this system) is non-negligible. (The <em>performance</em> isn&rsquo;t great either, although not too bad that this was really my first concern.)</p><p>In my ideal world, I&rsquo;d have &mldr;</p><ul><li>One system behind the scenes</li><li>With a unified API that <em>says what it intents to do</em>. (When reading, you clearly see &ldquo;this should be a red rectangle&rdquo; and &ldquo;this image should appear with size X and a shadow effect&rdquo;)</li><li>Completely known and controlled by me, for good performance and easy maintainability. (If there&rsquo;s one thing I&rsquo;ve learned, it&rsquo;s that every piece of code will be obsolete by next year, no matter how much you try to future-proof it.)</li></ul><p>So &mldr; how do we do this ourselves?</p><h2 id=icons-and-styles-attempt-2>Icons and Styles: attempt 2</h2><p>As I coded my latest generator, using that HTML-to-Canvas system from above, I realized something.</p><p>To get <em>images</em> inline with text, I had to &mldr;</p><ul><li>Break the text into an array of individual <code>&lt;span></code> nodes.</li><li>And replace the images needed by an <code>&lt;img></code> node pointed to the right thing.</li></ul><p>In other words, I had to create an array with individual pieces that I fed the system. (That&rsquo;s why I said the effort of using HTML-to-Canvas was non-negligible. You still need to turn everything into HTML nodes.)</p><p>But &mldr; I can just do that myself?</p><p>We can extend our TextDrawer to &mldr;</p><ul><li><strong>Parse</strong> the incoming text, automatically breaking it into images and style changes.</li><li>Then, instead of trying to draw the text word for word, we simply execute one &ldquo;element&rdquo; of this array at a time.</li></ul><p>Every single thing the text drawer might need to do, is an operation in this list. The basic ones would be &mldr;</p><ul><li>TextChunkText => just draw this text please</li><li>TextChunkImage => add this image. It automatically adds it at our current coordinates, with dimensions matching the font size.<ul><li>Because we know its size, we also know if it&rsquo;ll fit on the line or not! So this can just plug into our wrapping system we already have.</li></ul></li><li>TextChunkBreak => a forced line break</li><li>TextChunkStyle => a style change, such as &ldquo;regular&rdquo; to &ldquo;bold&rdquo;. (All text already uses the same <code>TextConfig</code> to know their style. I can simply clone this and modify as we go, based on these style changes.)</li></ul><p><em>What&rsquo;s with the names!?</em> There are obviously other parts in the system related to images, or styles, or text. As such, just &ldquo;Chunk&rdquo; (or Part or Component) isn&rsquo;t enough. The name <code>TextChunk</code> clearly differentiates it. (For completeness, one might even consider <code>TextBoxChunk</code>.)</p><p>Moreover, I always place the main category at the start, then its subcategory at the <em>end</em> of the name. The other way around is more natural for our natural language (&ldquo;roundedRectangle&rdquo; instead of &ldquo;rectangleRounded&rdquo;), but way harder to parse and work with in <em>code</em>. I might write an article about this some day: this simple switch-around with naming made my code much better.</p><p>So that&rsquo;s what I did.</p><ul><li>I wrote a <em>parser</em> that turns any text into this list of TextChunk components. (And if we already give it a list, it will just use that and do no parsing.)</li><li>In the <strong>first pass</strong>, it creates the general components. (Where are style changes? Where is a line break?) Text is kept together.</li><li>In the <strong>second pass</strong>, each TextChunk is broken into words and spaces. This is somewhat bad for performance, but leads to <em>much</em> cleaner code.<ul><li>Instead of measuring the whole line, seeing its too long, removing the last word, measuring again, etcetera &mldr;</li><li>We can now just step through the list of components, and add a line break whenever the next component doesn&rsquo;t fit, and that&rsquo;s it.</li></ul></li><li>So we step through, measure size, and <em>wrap</em> as usual.</li></ul><p>Below is a general overview of the code for this system. Once you&rsquo;ve seen/done it once, it&rsquo;s rather simple. But it took me a long time to understand how to even approach it and how to program it cleanly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>text</span> <span class=o>=</span> <span class=s2>&#34;You can &lt;b&gt;dance&lt;/b&gt; if you want to.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kr>const</span> <span class=nx>textParsed</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kr>const</span> <span class=nx>textWrapped</span> <span class=o>=</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>textParsed</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=nx>draw</span><span class=p>(</span><span class=nx>textWrapped</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1>// Turns a STRING into a set of TEXT_CHUNK objects
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>parse</span> <span class=o>=</span> <span class=p>(</span><span class=nx>text</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=kd>let</span> <span class=nx>regex</span> <span class=o>=</span> <span class=sr>/&lt;b&gt;|&lt;\/b&gt;/g</span> <span class=c1>// obviously not the full regular expression 
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>chunks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=kd>let</span> <span class=nx>match</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=nx>match</span> <span class=o>=</span> <span class=nx>regex</span><span class=p>.</span><span class=nx>exec</span><span class=p>(</span><span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>match</span><span class=p>)</span> <span class=p>{</span> <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>TextChunkText</span><span class=p>(</span><span class=nx>text</span><span class=p>));</span> <span class=k>break</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=kr>const</span> <span class=nx>str</span> <span class=o>=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// the full matched string
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>idx</span> <span class=o>=</span> <span class=nx>match</span><span class=p>.</span><span class=nx>index</span><span class=p>;</span> <span class=c1>// its position in entire string
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=kr>const</span> <span class=nx>theresTextBeforeTag</span> <span class=o>=</span> <span class=nx>idx</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>theresTextBeforeTag</span><span class=p>)</span> <span class=p>{</span> <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>TextChunkText</span><span class=p>(</span><span class=nx>text</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>idx</span><span class=p>)));</span> <span class=k>continue</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>str</span> <span class=o>==</span> <span class=s2>&#34;&lt;b&gt;&#34;</span><span class=p>)</span> <span class=p>{</span> <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>TextChunkStyle</span><span class=p>(</span><span class=s2>&#34;weight&#34;</span><span class=p>,</span> <span class=nx>TextWeight</span><span class=p>.</span><span class=nx>BOLD</span><span class=p>))</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>str</span> <span class=o>==</span> <span class=s2>&#34;&lt;/b&gt;&#34;</span><span class=p>)</span> <span class=p>{</span> <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>TextChunkStyle</span><span class=p>(</span><span class=s2>&#34;weight&#34;</span><span class=p>,</span> <span class=nx>TextWeight</span><span class=p>.</span><span class=nx>REGULAR</span><span class=p>))</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>str</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span> <span class=c1>// cut off the string at the start, keep only the remaining text
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>28</span><span class=cl>  <span class=p>}</span> <span class=k>while</span><span class=p>(</span><span class=nx>match</span><span class=p>);</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=k>return</span> <span class=nx>chunks</span><span class=p>;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=c1>// Determines where to place TextChunkBreak objects, hence wrapping the text
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>wrap</span> <span class=o>=</span> <span class=p>(</span><span class=nx>chunks</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>  <span class=kd>let</span> <span class=nx>lineWidth</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>  <span class=kr>const</span> <span class=nx>output</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kr>const</span> <span class=nx>chunk</span> <span class=k>of</span> <span class=nx>chunks</span><span class=p>)</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>    <span class=kr>const</span> <span class=nx>width</span> <span class=o>=</span> <span class=nx>chunk</span><span class=p>.</span><span class=nx>getWidth</span><span class=p>();</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>    <span class=kr>const</span> <span class=nx>newWidth</span> <span class=o>=</span> <span class=nx>lineWidth</span> <span class=o>+</span> <span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>    <span class=kr>const</span> <span class=nx>lineTooLong</span> <span class=o>=</span> <span class=nx>newWidth</span> <span class=o>&gt;</span> <span class=nx>textBoxWidth</span><span class=p>;</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>    
</span></span><span class=line><span class=ln>44</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>lineTooLong</span> <span class=o>||</span> <span class=nx>chunk</span> <span class=k>instanceof</span> <span class=nx>TextChunkBreak</span><span class=p>)</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=nx>lineTooLong</span><span class=p>)</span> <span class=p>{</span> <span class=nx>output</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>TextChunkBreak</span><span class=p>());</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>      <span class=nx>lineWidth</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>
</span></span><span class=line><span class=ln>50</span><span class=cl>    <span class=nx>lineWidth</span> <span class=o>+=</span> <span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>    <span class=nx>output</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>53</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>
</span></span><span class=line><span class=ln>55</span><span class=cl><span class=c1>// At this point, we&#39;re certain about everything (line breaks, chunks, etcetera)
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=c1>// So just _draw_ whatever needs to be drawn (using fillText, strokeText, and drawImage)
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>draw</span> <span class=o>=</span> <span class=p>(</span><span class=nx>chunks</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=ln>58</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>  <span class=kr>const</span> <span class=nx>position</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Point</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kr>const</span> <span class=nx>chunk</span> <span class=k>of</span> <span class=nx>textParsed</span><span class=p>)</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>chunk</span> <span class=k>instanceof</span> <span class=nx>TextChunkStyle</span><span class=p>)</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>      <span class=nx>textConfig</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>
</span></span><span class=line><span class=ln>68</span><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>chunk</span> <span class=k>instanceof</span> <span class=nx>TextChunkBreak</span><span class=p>)</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>70</span><span class=cl>      <span class=nx>position</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>71</span><span class=cl>      <span class=nx>position</span><span class=p>.</span><span class=nx>y</span> <span class=o>+=</span> <span class=nx>lineHeight</span><span class=p>;</span>
</span></span><span class=line><span class=ln>72</span><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=ln>73</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>74</span><span class=cl>
</span></span><span class=line><span class=ln>75</span><span class=cl>    <span class=nx>chunk</span><span class=p>.</span><span class=nx>draw</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=ln>76</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>77</span><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=whats-our-syntax>What&rsquo;s our syntax?</h3><p>I basically picked simplified HTML syntax for formatted text strings.</p><ul><li>Because I like the HTML syntax.</li><li>Because then it automatically supports the two outputs of my system: canvas and HTML.</li></ul><p>In practice, this means that if I want to make text <strong>bold</strong>, I write <code>&lt;b>&lt;/b></code> around it. If I want an image inline with text, I use <code>&lt;img></code>.</p><p>This allows me to keep the data underpinning the games simple and readable.</p><p>For example, one &ldquo;special power&rdquo; in a game might read <code>If used, draw &lt;b>2 cards&lt;/b>.</code></p><p>Very readable, but also easy to parse into different chunks.</p><ul><li>Text: &ldquo;If used, draw "</li><li>Style: &ldquo;weight&rdquo; to &ldquo;bold&rdquo;</li><li>Text: &ldquo;2 cards&rdquo;</li><li>Style: &ldquo;weight&rdquo; to &ldquo;normal&rdquo;</li></ul><h3 id=style-changes-through-state-management>Style changes through state management</h3><p>If all you want to do is make text <strong>bold</strong> and then normal again, this works.</p><p>But once we add more complex formatting, we really need a <em>stack</em> that tracks our state changes. So that, instead of manually specifying the new value, we can just say &ldquo;remove the last modification&rdquo;.</p><p>For example, I want to support <strong>coloring</strong> text differently.</p><ul><li>To set a new color (from now on), use <code>&lt;col hex="#aabbcc"></code></li><li>To <em>remove</em> that color again, I want to be able to just do <code>&lt;/col></code>.</li></ul><p>When not given a new value, it should automatically pop the last known value off the stack and reset the style to the previous value.</p><p>To do so, I added a simple <code>history</code> variable that tracks the history of all values in the <code>TextConfig</code> as we go.</p><h3 id=how-to-do-images>How to do images?</h3><p>To parse images inline with text, we use the same approach as the one above for colors: <code>&lt;img id="theimage" frame="theframe"></code>.</p><p>We, however, need an extra step, because images are an <em>external resource</em>.</p><p>We need to pass in the ResourceLoader, so it can grab the correct image by <em>id</em> and <em>frame</em> (if it&rsquo;s a spritesheet).</p><p>I was stumped on how to approach this in a clean way. I really didn&rsquo;t want to modify a bunch of functions to <em>also</em> pass in the ResourceLoader every time. (Especially because we don&rsquo;t need one if the text has no images, which is currently 99% of the text in my game generators.)</p><p>Then I realized this was a <em>configuration</em> thing, and we already have that nice <code>TextConfig</code> running all that!</p><p>I extended that class to optionally hold a ResourceLoader, which is used for all images when drawing.</p><p>Still, images are a whole different beast. There are endless remaining questions here.</p><ul><li>How to align the image?</li><li>How to calculate / manually set its size?</li><li>What if we want to add common effects (such as outline or shadow) to the icons?</li></ul><p>On my website, all those things are handled by the <code>LayoutOperation</code> class. Whenever you draw something, it accepts an optional LayoutOperation which holds dimensions, position, FX, etcetera.</p><p>As such, we already have <em>global</em> support for this. Whenever I draw text, I can pass an operation to add shadow or whatever to the <em>whole</em> text.</p><p>To add <em>local</em> support (only to one or more chunks) &mldr; I saw no way to do so via string parsing. It would get messy. If I want to do that, I&rsquo;ll have to pass in the text as an array of chunks.</p><p>If we have that, this actually becomes trivial: allow attaching a LayoutOperation to any chunk, and we&rsquo;re done. (I want an image with shadow? I simply add the ShadowEffect to that particular TextChunkImage.)</p><p>By default&mdash;if I simply say &ldquo;draw this image&rdquo; with nothing else&mdash;it will &mldr;</p><ul><li>Make the image the same size as the font.</li><li>And make it sit on the same baseline.</li></ul><p>That should usually be what you want.</p><h3 id=doing-the-aligning-ourselves>Doing the aligning ourselves</h3><p>All of this has one major downside, though. <strong>We can&rsquo;t use the built-in aligning from canvas anymore.</strong></p><p>Because if we align text to the center &mldr; and then add an image &mldr; those positions will not line up.</p><p>We have to draw everything from the same anchor point (top-left corner), and do aligning <em>ourselves</em>.</p><p>Fortunately, we now have the text broken into chunks with a nice <code>getSize()</code> function. We call it to find the <strong>total dimensions</strong> of each line, which allows us to center it.</p><ul><li>Align left? Do nothing.</li><li>Align right? Calculate the remaining space (total text box size <em>minus</em> actual text size). Start from that coordinate.</li><li>Align center? Calculate the remaining space, <em>half it</em>, start from that coordinate.</li></ul><p>This is true for both horizontal and vertical aligning. Though horizontal is <em>per line</em>, and vertical is <em>once for the whole block</em>.</p><h3 id=other-minor-tweaks>Other minor tweaks</h3><p>Creating this system made me realize how many small &ldquo;exceptions&rdquo; go into wrapping text in a good way.</p><p>For example: adding spaces to the start of a new line looks weird. How to fix?</p><ul><li>When parsing the text</li><li>If we encounter an empty space, and the previous chunk is a LineBreak,</li><li>Just throw away the empty space entirely</li></ul><p>Similarly, we don&rsquo;t want &ldquo;orphans&rdquo;. For example, an entire line fits on the same line &mldr; but the final period (<code>.</code>) doesn&rsquo;t, which requires an entire line wrap just for that!</p><p>To fix something like that,</p><ul><li>I added a &ldquo;moveLineBreak&rdquo; function.</li><li>And two functions to check the path to the nearest <em>visible element</em>, before and after a chunk.</li><li>So that I can check if this path contains a line break and/or is long enough.<ul><li>The line is too short to be on its own? Move the line break back to add more to this line.</li><li>It&rsquo;s punctuation on a new line? Move the line break back to add the last word of the previous line.</li></ul></li></ul><p>Stuff like that creates a handful of nasty exceptions in the code, but it&rsquo;s worth it for how much cleaner and more readable it looks.</p><h2 id=where-are-we-now>Where are we now?</h2><p>Pfew. Those were a few tough days, hammering out code and fixing obscure bugs.</p><p>But now that we&rsquo;re done, I have a <em>much more powerful</em> text rendering engine to use. With capabilities that any framework or library I researched did not (easily) support.</p><ul><li>We can change the text style at will. (Bold, italic, size, font, small-caps, color, you name it.)</li><li>We can align it any way we want.</li><li>We can insert images inline.</li><li>And all of that uses the same API as the rest of my systems, which also means we can apply the same effects and features to all of that. (It also means that, in most cases, I can still just give it a simple string without overhead.)</li></ul><p>It&rsquo;s quite a bit slower to render. I&rsquo;ll have to research ways to increase performance, but for now it&rsquo;s &ldquo;fast enough&rdquo;. (The real bottlenecks are in other parts of the system, certainly not the TextDrawer.)</p><p>Looking at the next 20+ games I have planned, I can&rsquo;t see anything else I might want from text rendering. Even so, if something <em>does</em> come along, I now completely control and understand this system, so it should be easy to add that functionality.</p><p>Below is an example of the first game I quickly converted to the new system. (Before using <em>italics</em>, there was no emphasis or I CAPITALIZED important words.)</p><p><figure class=inline-image><picture><img src=pandaqi_formatted_text.webp loading=lazy decoding=async alt="Switching this whole game to the new system took only a minute of adding EM-tags." title="Switching this whole game to the new system took only a minute of adding EM-tags." width=1077 height=880></picture><figcaption class=side-note><span>Switching this whole game to the new system took only a minute of adding EM-tags.</span></figcaption></figure></p><p>And that&rsquo;s it!</p><p>I&rsquo;ve already converted a few of the latest games to this new system. Formatted text just looks so much more professional and readable. You can clearly emphasize words or create structure/hierarchy, without being messy or distracting.</p><p>Knowing how &ldquo;easy&rdquo; it is to do it&mdash;using this technique&mdash;it boggles my mind how few frameworks support this. Then again, for <em>most</em> applications you can say &ldquo;just use basic HTML + CSS for powerful text rendering&rdquo; and you&rsquo;d be fine. My specific requirements, workflow and projects just made that impossible or annoying.</p><p>Of course, over time I&rsquo;ll make the code cleaner and more performant, and probably find some bugs to fix.</p><p>For now, my nightmare with text is over.</p><p>Until the next update, keep playing,</p><p>Pandaqi</p></div></article><div><nav class=pagination><ul><li><a href=/blog/news-and-updates/why-my-games-were-removed-from-the-play-store/ class="masked-link big-mask mask-3" style=--rotation:1.5deg>&lt;&lt; Previous Page</a></li><li>Continue reading</li><li><a href=/blog/news-and-updates/my-journey-to-becoming-a-game-designer/ class="masked-link big-mask mask-5" style=--rotation:-1.5deg>>> Next Page</a></li></ul></nav></div></main><footer id=site-footer><div class="padding center-block"><h3>More Pandaqi</h3><p>You could <a href=https://pandaqi.com>visit the game studio</a>.
Or my <a href=https://pandaqi.com/tutorials/>free tutorial website</a>.
Or my <a href=https://rodepanda.com/>portfolio</a> with easy access to absolutely everything I ever made.</p><h3>Latest</h3><nav class=latest><ul><li><a href=/blog/reviews-and-thoughts/should-you-let-your-kids-win/>Should you let your kids win?
(üí¨)</a></li><li><a href=/blog/boardgames/slippery-slopes/>Slippery Slopes
(üêò)</a></li><li><a href=/blog/news-and-updates/pandaqi-games-2024-update/>Pandaqi Games: 2024 Update
(üéÆ)</a></li><li><a href=/blog/reviews-and-thoughts/why-rules-should-be-less-strict/>Why rules should be less strict
(üí¨)</a></li><li><a href=/blog/boardgames/mammoth-messages/>Mammoth Messages
(üêò)</a></li><li><a href=/blog/boardgames/kangaruse/>Kangaruse
(ü¶ò)</a></li><li><a href=/blog/news-and-updates/my-journey-to-becoming-a-game-designer/>My Journey to Becoming a Game Designer
(üé≤)</a></li><li><a href=/blog/news-and-updates/pandaqi-games-solving-the-nightmare-of-text/>Pandaqi Games: Solving the Nightmare called Text
(üéÆ)</a></li><li><a href=/blog/boardgames/waitless-games/creature-quellector/>Creature Quellector
(üêâ)</a></li><li><a href=/blog/boardgames/waitless-games/finger-food/>Finger Food
(üñêÔ∏è)</a></li></ul></nav><h3>Sections</h3><nav><ul><li><a href=/blog/boardgames/>Boardgames
(üé≤)</a></li><li><a href=/blog/news-and-updates/>News & Updates
(üì¢)</a></li><li><a href=/blog/reviews-and-thoughts/>Reviews & Thoughts
(üí≠)</a></li><li><a href=/blog/tutorials/>Tutorials
(üë©‚Äçüéì)</a></li><li><a href=/blog/videogames/>Videogames
(üéÆ)</a></li></ul></nav><h3>Credits</h3><p>Theme by me (<a href=https://pandaqi.com>Pandaqi</a> üêº) &#183;
with ‚ù§Ô∏è &#183;
using <a href=https://gohugo.io>Hugo</a> &#183;
&copy; 2018&ndash;2024 Pandaqi Blog</p></div></footer><link rel=stylesheet type=text/css href=/blog/css/style.css><script src=/blog/js/main.bundle.min.js async defer></script></body></html>